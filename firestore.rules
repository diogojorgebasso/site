rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    function auth(){
    	return request.auth != null
    }
    
    function matchesUser(data){
    	return request.auth.uid == uid
    }
    
    function notUpdating(field){
    	return !(field in request.resource.data) || resource.data[field] == request.resource.data[field]
    }
    allow update: if auth() && matchesUser(resource.data) && notUpdating("userId")
    
    match /${param:CUSTOMERS_COLLECTION}/{uid} {
      allow read: if auth() && matchesUser(resource.data);

      match /checkout_sessions/{id} {
        allow read, write: if auth() && matchesUser(resource.data);
      }
      match /subscriptions/{id} {
        allow read: if auth() && matchesUser(resource.data);
      }
    }

    match /${param:PRODUCTS_COLLECTION}/{id} {
      allow read: if true;

      match /prices/{id} {
        allow read: if true;
      }
      
      match /tax_rates/{id} {
        allow read: if true;
      }
    }
  }
}
